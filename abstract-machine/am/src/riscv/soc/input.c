#include "../soc.h"
#include "stdio.h"
#include <am.h>
#include <stdint.h>

#define KEYDOWN_MASK 0xff00
#define KBD_ADDR 0x10011000

uint32_t codes[] = {
    0x76, 0x05, 0x06,   0x04,   0x0c, 0x03, 0x0b,
    0x83, 0x0a, 0x01,   0x09,   0x78,
    0x07, // end1
    0x01, 0x16, 0x1e,   0x26,   0x25, 0x2e, 0x36,
    0x3d, 0x3e, 0x46,   0x45,   0x4e, 0x55, 0x5d,
    0x66, // end2
    0x0d, 0x15, 0x1d,   0x24,   0x2d, 0x2c, 0x35,
    0x3c, 0x43, 0x44,   0x4d,   0x54,
    0x5b, 0xff,// end3 TODO:BACKSLASH
    0x58, 0x1c, 0x1b,   0x23,   0x2b, 0x34, 0x33,
    0x3b, 0x42, 0x4b,   0x4c,   0x52,
    0x5a, // end4
    0x12, 0x1a, 0x22,   0x21,   0x2a, 0x32, 0x31,
    0x3a, 0x41, 0x49,   0x4a,   0x59, // end5
    0x14,           0xff,                  // TODO:application
    0x11, 0x29, 0xE011, 0xE014,       // end6
    //TODO:拓展码-通码？
    


};
uint32_t get_code(uint32_t keycode) {
  for (int i = 0; i < sizeof(codes) / sizeof(uint32_t); i++) {
    if (codes[i] == keycode)
      return i;
  }
  return 0;
}

void __am_input_keybrd(AM_INPUT_KEYBRD_T *kbd) {
  uint32_t code = inw(KBD_ADDR);
  // printf("kbd->keydown=%d,,kbd->keycode=%d\n",(code & KEYDOWN_MASK ? true :
  // false),code & ~KEYDOWN_MASK);
  kbd->keydown = (code & KEYDOWN_MASK);
  kbd->keycode = get_code(code & ~KEYDOWN_MASK);
}
